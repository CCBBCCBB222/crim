-- åŸºç¡€æœåŠ¡å¼•ç”¨
local Players = game:GetService('Players')
local LocalPlayer = Players.LocalPlayer
local KickFunc = LocalPlayer.Kick
local RobloxEnv = getrenv()

-- ========== åæ£€æµ‹ä¿æŠ¤ç³»ç»Ÿ ==========

-- é’©ä½Kickå‡½æ•°ï¼Œé˜²æ­¢è¢«æ¸¸æˆè¸¢å‡º
hookfunction(KickFunc, newcclosure(function(self, reason)
    -- è¿”å›ä¸€ä¸ªæé•¿çš„ç­‰å¾…æ—¶é—´ï¼Œå®é™…æ•ˆæœæ˜¯é˜»æ­¢è¸¢å‡º
    return task.wait(9e9)
end))

-- é’©ä½å…ƒæ–¹æ³•ï¼Œæ‹¦æˆªæ‰€æœ‰åç§°è°ƒç”¨
local old
old = hookmetamethod(game, "__namecall", newcclosure(function(self, ...)
    local Name = getnamecallmethod() -- è·å–è°ƒç”¨çš„æ–¹æ³•å
    
    -- å¦‚æœæ£€æµ‹åˆ°Kickè°ƒç”¨ï¼ŒåŒæ ·é˜»æ­¢
    if Name == 'Kick' or Name == 'kick' then
        return task.wait(9e9)
    end
    
    -- å…¶ä»–è°ƒç”¨æ­£å¸¸æ‰§è¡Œ
    return old(self, ...)
end))

-- æ‰«æåƒåœ¾å›æ”¶å™¨ï¼ŒæŸ¥æ‰¾åä½œå¼Šå‡½æ•°å¹¶è¿›è¡Œé’©ä½
local Detected, Kill
for i, v in getgc(true) do
    if typeof(v) ~= 'table' then continue end -- åªå¤„ç†tableç±»å‹

    -- æŸ¥æ‰¾åä½œå¼Šç³»ç»Ÿçš„æ£€æµ‹å‡½æ•°
    local DetectFunc = rawget(v, "Detected")
    local KillFunc = rawget(v, "Kill")

    -- é’©ä½æ£€æµ‹å‡½æ•°ï¼Œè®©å®ƒæ€»æ˜¯è¿”å›trueï¼ˆæ¬ºéª—åä½œå¼Šç³»ç»Ÿï¼‰
    if typeof(DetectFunc) == "function" and not Detected then
        Detected = DetectFunc
        hookfunction(DetectFunc, newcclosure(function()
            return true -- è®©åä½œå¼Šç³»ç»Ÿè®¤ä¸ºä¸€åˆ‡æ­£å¸¸
        end))
    end

    -- é’©ä½ç»ˆæ­¢å‡½æ•°ï¼Œé˜²æ­¢è„šæœ¬è¢«å¼ºåˆ¶å…³é—­
    if rawget(v, "Variables") and rawget(v, "Process") and typeof(KillFunc) == "function" and not Kill then
        Kill = KillFunc
        hookfunction(KillFunc, newcclosure(function()
            return true -- é˜»æ­¢ç»ˆæ­¢æ“ä½œ
        end))
    end
end

-- é’©ä½debug.infoå‡½æ•°ï¼Œå¹²æ‰°åä½œå¼Šç³»ç»Ÿçš„è°ƒè¯•æ£€æµ‹
local old
old = hookfunction(RobloxEnv.debug.info, newcclosure(function(...)
    local Func = ...
    -- å¦‚æœæ£€æµ‹åˆ°åä½œå¼Šå‡½æ•°è¢«è°ƒè¯•ï¼Œå°±æŒ‚èµ·å½“å‰åç¨‹
    if Func == Detected or Func == Kill then
        return coroutine.yield(coroutine.running())
    end
    return old(...)
end))

-- ========== æ¸¸æˆæœåŠ¡åˆå§‹åŒ– ==========
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- æ¸¸æˆè¿œç¨‹äº‹ä»¶å¼•ç”¨ï¼ˆç”¨äºæ¨¡æ‹Ÿå°„å‡»ï¼‰
local GNX_S = ReplicatedStorage:WaitForChild("Events"):WaitForChild("GNX_S")
local ZFKLF_H = ReplicatedStorage:WaitForChild("Events"):WaitForChild("ZFKLF_H")

-- ========== UIç•Œé¢åº“åŠ è½½ ==========
local repo = 'https://raw.githubusercontent.com/mstudio45/LinoriaLib/main/'
local Library = loadstring(game:HttpGet(repo .. 'Library.lua'))()  -- ä¸»ç•Œé¢åº“
local ThemeManager = loadstring(game:HttpGet(repo .. 'addons/ThemeManager.lua'))()  -- ä¸»é¢˜ç®¡ç†
local SaveManager = loadstring(game:HttpGet(repo .. 'addons/SaveManager.lua'))()  -- é…ç½®ä¿å­˜
local Options = Library.Options
local Toggles = Library.Toggles

-- ç•Œé¢åŸºç¡€è®¾ç½®
Library.ShowToggleFrameInKeybinds = true  -- åœ¨é”®ä½ç»‘å®šä¸­æ˜¾ç¤ºåˆ‡æ¢æ¡†æ¶
Library.ShowCustomCursor = true          -- æ˜¾ç¤ºè‡ªå®šä¹‰å…‰æ ‡
Library.NotifySide = "Left"              -- é€šçŸ¥æ˜¾ç¤ºä½ç½®

-- åˆ›å»ºä¸»çª—å£
local Window = Library:CreateWindow({
    Title = 'ske.gg - Ragebot',  -- çª—å£æ ‡é¢˜
    Center = true,               -- å±…ä¸­æ˜¾ç¤º
    AutoShow = true,             -- è‡ªåŠ¨æ˜¾ç¤º
    Resizable = true,            -- å¯è°ƒæ•´å¤§å°
    ShowCustomCursor = true,
    NotifySide = "Left",
    TabPadding = 8,
    MenuFadeTime = 0.2
})

-- ========== ç•Œé¢æ ‡ç­¾é¡µåˆ›å»º ==========
local Tabs = {
    Ragebot = Window:AddTab('Ragebot'),        -- è‡ªåŠ¨ç„å‡†è®¾ç½®é¡µ
    ['UI Settings'] = Window:AddTab('UI Settings')  -- ç•Œé¢è®¾ç½®é¡µ
}

-- å·¦ä¾§è®¾ç½®ç»„
local RageLeft = Tabs.Ragebot:AddLeftGroupbox('Ragebot Settings')

-- ========== å…¨å±€å˜é‡åˆå§‹åŒ– ==========
getgenv().RageEnabled = false        -- æ€»å¼€å…³
getgenv().FireRate = 5               -- å°„é€Ÿï¼ˆæ¯ç§’å‘å°„æ¬¡æ•°ï¼‰
getgenv().Prediction = true          -- æ˜¯å¦å¼€å¯é¢„æµ‹
getgenv().PredictionAmount = 0.1     -- é¢„æµ‹é‡
getgenv().TracerColor = Color3.fromRGB(255, 0, 0)  -- è½¨è¿¹é¢œè‰²
getgenv().TracerWidth = 0.3          -- è½¨è¿¹å®½åº¦
getgenv().TracerLifetime = 0.3       -- è½¨è¿¹å­˜åœ¨æ—¶é—´
getgenv().VisibilityCheck = true     -- è§†çº¿æ£€æµ‹
getgenv().LastShot = 0               -- ä¸Šæ¬¡å°„å‡»æ—¶é—´
getgenv().TargetLock = false         -- ç›®æ ‡é”å®š
getgenv().LockedTargets = {}         -- é”å®šç›®æ ‡åˆ—è¡¨
getgenv().Whitelist = {}             -- ç™½åå•

-- ========== ç•Œé¢æ§ä»¶è®¾ç½® ==========

-- æ€»å¼€å…³
RageLeft:AddToggle('RageEnabled', {
    Text = 'Enable Ragebot',
    Default = false,
    Callback = function(Value)
        getgenv().RageEnabled = Value
    end
})

-- å°„é€Ÿè°ƒèŠ‚æ»‘å—
RageLeft:AddSlider('FireRate', {
    Text = 'FireRate (Higher = Faster)',
    Default = 5,
    Min = 1,
    Max = 20,
    Rounding = 0,
    Callback = function(Value)
        getgenv().FireRate = Value
    end
})

-- é¢„æµ‹å¼€å…³
RageLeft:AddToggle('Prediction', {
    Text = 'Prediction',
    Default = true,
    Callback = function(Value)
        getgenv().Prediction = Value
    end
})

-- é¢„æµ‹é‡è°ƒèŠ‚
RageLeft:AddSlider('PredictionAmount', {
    Text = 'Prediction Amount',
    Default = 0.1,
    Min = 0.05,
    Max = 0.3,
    Rounding = 2,
    Callback = function(Value)
        getgenv().PredictionAmount = Value
    end
})

-- è§†çº¿æ£€æµ‹å¼€å…³
RageLeft:AddToggle('VisibilityCheck', {
    Text = 'Visibility Check',
    Default = true,
    Callback = function(Value)
        getgenv().VisibilityCheck = Value
    end
})

-- è½¨è¿¹æ˜¾ç¤ºå¼€å…³å’Œé¢œè‰²é€‰æ‹©
RageLeft:AddToggle('TracerEnabled', {
    Text = 'Tracer',
    Default = false,
    Callback = function(Value)
        getgenv().TracerEnabled = Value
    end
}):AddColorPicker('TracerColor', {
    Default = Color3.fromRGB(255, 0, 0),
    Callback = function(Value)
        getgenv().TracerColor = Value
    end
})

-- ç›®æ ‡é”å®šå¼€å…³
RageLeft:AddToggle('TargetLock', {
    Text = 'Target Lock',
    Default = false,
    Callback = function(Value)
        getgenv().TargetLock = Value
        if not Value then
            getgenv().LockedTargets = {}  -- å…³é—­æ—¶æ¸…ç©ºé”å®šåˆ—è¡¨
        end
    end
})

-- è½¨è¿¹å®½åº¦è°ƒèŠ‚
RageLeft:AddSlider('TracerWidth', {
    Text = 'Tracer Width',
    Default = 0.3,
    Min = 0.1,
    Max = 2,
    Rounding = 1,
    Callback = function(Value)
        getgenv().TracerWidth = Value
    end
})

-- è½¨è¿¹å­˜åœ¨æ—¶é—´è°ƒèŠ‚
RageLeft:AddSlider('TracerLifetime', {
    Text = 'Tracer Lifetime',
    Default = 0.3,
    Min = 0.1,
    Max = 1,
    Rounding = 1,
    Callback = function(Value)
        getgenv().TracerLifetime = Value
    end
})

-- ========== å·¥å…·å‡½æ•°å®šä¹‰ ==========

-- ç”Ÿæˆéšæœºå­—ç¬¦ä¸²ï¼ˆç”¨äºæ¨¡æ‹Ÿç½‘ç»œæ•°æ®ï¼‰
function RandomString(length)
    local charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"
    local result = ""
    for i = 1, length do
        result = result .. charset:sub(math.random(1, #charset), math.random(1, #charset))
    end
    return result
end

-- æ’­æ”¾å‘½ä¸­éŸ³æ•ˆ
function playHitSound()
    local sound = Instance.new("Sound")
    sound.SoundId = "rbxassetid://6534948092"  -- éŸ³æ•ˆID
    sound.Volume = 1
    sound.PlayOnRemove = true  -- é”€æ¯æ—¶æ’­æ”¾
    sound.Parent = Camera
    sound:Destroy()  -- ç«‹å³é”€æ¯è§¦å‘æ’­æ”¾
end

-- è§†çº¿æ£€æµ‹å‡½æ•°ï¼ˆåˆ¤æ–­æ˜¯å¦å¯ä»¥çœ‹è§ç›®æ ‡ï¼‰
function canSeeTarget(targetPart)
    if not getgenv().VisibilityCheck then
        return true  -- å¦‚æœå…³é—­è§†çº¿æ£€æµ‹ï¼Œç›´æ¥è¿”å›å¯è§
    end

    -- åˆ›å»ºå°„çº¿æ£€æµ‹å‚æ•°
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    raycastParams.FilterDescendantsInstances = {LocalPlayer.Character}  -- å¿½ç•¥è‡ªå·±çš„è§’è‰²

    local startPos = Camera.CFrame.Position  -- å°„çº¿èµ·ç‚¹ï¼ˆç›¸æœºä½ç½®ï¼‰
    local endPos = targetPart.Position       -- å°„çº¿ç»ˆç‚¹ï¼ˆç›®æ ‡ä½ç½®ï¼‰
    local direction = (endPos - startPos)    -- æ–¹å‘å‘é‡
    local distance = direction.Magnitude     -- è·ç¦»

    -- æ‰§è¡Œå°„çº¿æ£€æµ‹
    local raycastResult = workspace:Raycast(startPos, direction.Unit * distance, raycastParams)

    if raycastResult then
        local hitPart = raycastResult.Instance
        if hitPart and hitPart.CanCollide then
            local model = hitPart:FindFirstAncestorOfClass("Model")
            if model then
                local humanoid = model:FindFirstChild("Humanoid")
                if humanoid then
                    return true  -- å¦‚æœå‡»ä¸­çš„æ˜¯ç©å®¶æ¨¡å‹ï¼Œè®¤ä¸ºæ˜¯å¯è§çš„
                end
            end
            return false  -- å‡»ä¸­äº†éšœç¢ç‰©ï¼Œä¸å¯è§
        end
    end
    return true  -- æ²¡æœ‰å‡»ä¸­ä»»ä½•ç‰©ä½“ï¼Œå¯è§
end

-- è·å–æœ€è¿‘çš„å¯æ”»å‡»ç©å®¶
function getClosest()
    local closest = nil     -- æœ€è¿‘çš„ç›®æ ‡
    local shortest = math.huge  -- æœ€çŸ­è·ç¦»ï¼ˆåˆå§‹è®¾ä¸ºæå¤§å€¼ï¼‰

    -- éå†æ‰€æœ‰ç©å®¶
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character then  -- æ’é™¤è‡ªå·±ä¸”è§’è‰²å­˜åœ¨
            local h = p.Character:FindFirstChild("Humanoid")
            local head = p.Character:FindFirstChild("Head")

            -- æ£€æŸ¥è§’è‰²æ˜¯å¦å­˜æ´»ä¸”æœ‰å¤´éƒ¨
            if h and h.Health > 0 and head then
                if getgenv().VisibilityCheck then
                    -- å¦‚æœéœ€è¦è§†çº¿æ£€æµ‹
                    if canSeeTarget(head) then
                        local dist = (head.Position - Camera.CFrame.Position).Magnitude
                        if dist < shortest then
                            shortest = dist
                            closest = head
                        end
                    end
                else
                    -- ä¸éœ€è¦è§†çº¿æ£€æµ‹ï¼Œç›´æ¥è®¡ç®—è·ç¦»
                    local dist = (head.Position - Camera.CFrame.Position).Magnitude
                    if dist < shortest then
                        shortest = dist
                        closest = head
                    end
                end
            end
        end
    end

    return closest  -- è¿”å›æœ€è¿‘çš„ç›®æ ‡å¤´éƒ¨
end

-- è·å–å½“å‰æ‰‹æŒçš„å·¥å…·
function getCurrentTool()
    if LocalPlayer.Character then
        for _, tool in pairs(LocalPlayer.Character:GetChildren()) do
            if tool:IsA("Tool") then
                return tool
            end
        end
    end
    return nil
end

-- åˆ›å»ºå°„å‡»è½¨è¿¹æ•ˆæœ
function createTracer(targetHead)
    if not getgenv().TracerEnabled or not targetHead then
        return  -- è½¨è¿¹åŠŸèƒ½æœªå¼€å¯æˆ–æ²¡æœ‰ç›®æ ‡æ—¶è¿”å›
    end

    -- åˆ›å»ºå…‰æŸæ•ˆæœ
    local beam = Instance.new("Beam")
    beam.Color = ColorSequence.new(getgenv().TracerColor)  -- è½¨è¿¹é¢œè‰²
    beam.Width0 = getgenv().TracerWidth  -- èµ·å§‹å®½åº¦
    beam.Width1 = getgenv().TracerWidth  -- ç»“æŸå®½åº¦
    beam.Texture = "rbxassetid://7136858729"  -- çº¹ç†ID
    beam.TextureSpeed = 2    -- çº¹ç†æµåŠ¨é€Ÿåº¦
    beam.Brightness = 5      -- äº®åº¦
    beam.LightEmission = 1   -- å…‰å‘å°„
    beam.FaceCamera = true   -- å§‹ç»ˆé¢å‘ç›¸æœº

    -- åˆ›å»ºä¸¤ä¸ªé™„ç€ç‚¹ï¼ˆèµ·ç‚¹å’Œç»ˆç‚¹ï¼‰
    local a0 = Instance.new("Attachment")
    local a1 = Instance.new("Attachment")

    -- è®¾ç½®èµ·ç‚¹ä½ç½®ï¼ˆç©å®¶è§’è‰²æˆ–ç›¸æœºä½ç½®ï¼‰
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        a0.WorldPosition = LocalPlayer.Character.HumanoidRootPart.Position
    else
        a0.WorldPosition = Camera.CFrame.Position
    end

    -- è®¾ç½®ç»ˆç‚¹ä½ç½®ï¼ˆç›®æ ‡å¤´éƒ¨ï¼‰
    a1.WorldPosition = targetHead.Position

    -- è¿æ¥é™„ç€ç‚¹å’Œå…‰æŸ
    beam.Attachment0 = a0
    beam.Attachment1 = a1
    beam.Parent = Workspace
    a0.Parent = Workspace
    a1.Parent = Workspace

    -- å®šæ—¶é”€æ¯è½¨è¿¹æ•ˆæœ
    delay(getgenv().TracerLifetime, function()
        beam:Destroy()
        a0:Destroy()
        a1:Destroy()
    end)
end

-- æ ¸å¿ƒå°„å‡»å‡½æ•°
function shoot(head)
    local tool = getCurrentTool()
    if not tool then
        return  -- æ²¡æœ‰å·¥å…·æ—¶è¿”å›
    end

    -- æŸ¥æ‰¾å·¥å…·çš„å¿…è¦ç»„ä»¶
    local values = tool:FindFirstChild("Values")
    local hitMarker = tool:FindFirstChild("Hitmarker")
    if not values or not hitMarker then
        return
    end

    -- æ£€æŸ¥å¼¹è¯
    local ammo = values:FindFirstChild("SERVER_Ammo")
    local storedAmmo = values:FindFirstChild("SERVER_StoredAmmo")
    if not ammo or not storedAmmo or ammo.Value <= 0 then
        return  -- æ²¡æœ‰å¼¹è¯æ—¶è¿”å›
    end

    -- è®¡ç®—å‘½ä¸­ä½ç½®å’Œæ–¹å‘
    local hitPosition = head.Position
    local hitDirection = (hitPosition - Camera.CFrame.Position).Unit

    -- å¦‚æœå¼€å¯é¢„æµ‹ï¼Œæ ¹æ®ç›®æ ‡é€Ÿåº¦è°ƒæ•´å‘½ä¸­ä½ç½®
    if getgenv().Prediction then
        local velocity = head.Velocity or Vector3.zero
        hitPosition = hitPosition + velocity * getgenv().PredictionAmount
        hitDirection = (hitPosition - Camera.CFrame.Position).Unit
    end

    -- ç”Ÿæˆéšæœºå¯†é’¥ï¼ˆæ¨¡æ‹Ÿåˆæ³•ç½‘ç»œæ•°æ®ï¼‰
    local randomKey = RandomString(30) .. "0"
    
    -- æ„é€ è¿œç¨‹äº‹ä»¶å‚æ•°
    local args1 = {tick(), randomKey, tool, "FDS9I83", shootPosition, {hitDirection}, false}
    local args2 = {"ğŸ§ˆğŸ§ˆ", tick(), tool, randomKey, 1, head, hitPosition, hitDirection, 19052023.49}

    -- è§¦å‘è¿œç¨‹äº‹ä»¶ï¼ˆæ¨¡æ‹Ÿå°„å‡»åŠ¨ä½œï¼‰
    GNX_S:FireServer(unpack(args1))
    ZFKLF_H:FireServer(unpack(args2))

    -- æ›´æ–°å¼¹è¯æ•°é‡
    ammo.Value = math.max(ammo.Value - 1, 0)
    hitMarker:Fire(head)  -- è§¦å‘å‘½ä¸­æ ‡è®°
    storedAmmo.Value = storedAmmo.Value  -- ä¿æŒå­˜å‚¨å¼¹è¯ä¸å˜

    -- åˆ›å»ºè½¨è¿¹å’ŒéŸ³æ•ˆ
    createTracer(head)
    playHitSound()
end

-- ========== ä¸»å¾ªç¯ ==========
task.spawn(function()
    while true do
        -- æ ¹æ®å°„é€Ÿè®¡ç®—ç­‰å¾…æ—¶é—´
        local waitTime = 1 / getgenv().FireRate
        task.wait(waitTime)

        -- æ£€æŸ¥æ˜¯å¦å¯ç”¨è‡ªåŠ¨ç„å‡†ä¸”è¾¾åˆ°å°„å‡»é—´éš”
        if getgenv().RageEnabled and tick() - getgenv().LastShot >= waitTime then
            createTracer(head)  -- åˆ›å»ºè½¨è¿¹ï¼ˆè¿™é‡Œheadå˜é‡å¯èƒ½æœ‰é—®é¢˜ï¼‰
            local target = getClosest()  -- è·å–æœ€è¿‘ç›®æ ‡
            
            if target then
                shoot(head)  -- å°„å‡»ç›®æ ‡ï¼ˆè¿™é‡Œheadå˜é‡å¯èƒ½æœ‰é—®é¢˜ï¼‰
                getgenv().LastShot = tick()  -- æ›´æ–°æœ€åå°„å‡»æ—¶é—´
            end
        end
    end
end)

-- ========== ç•Œé¢ä¸»é¢˜å’Œé…ç½®ç®¡ç† ==========
ThemeManager:SetLibrary(Library)
SaveManager:SetLibrary(Library)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({'MenuKeybind'})
SaveManager:BuildConfigSection(Tabs['UI Settings'])  -- åœ¨UIè®¾ç½®é¡µæ·»åŠ é…ç½®ç®¡ç†
ThemeManager:ApplyToTab(Tabs['UI Settings'])        -- åº”ç”¨ä¸»é¢˜è®¾ç½®
SaveManager:LoadAutoloadConfig()                    -- åŠ è½½è‡ªåŠ¨ä¿å­˜çš„é…ç½®